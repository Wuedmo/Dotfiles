#!/bin/bash
source "$HOME/.local/share/dotfiles/bin/lib/helpers.sh"

# Parse common flags (export DRY_RUN/FORCE_CACHYOS)
if type parse_common_flags >/dev/null 2>&1; then
  parse_common_flags "$@" >/dev/null
fi

if is_cachyos; then
  fzf_args=(
    --multi
    --preview 'pacman -Si {2}'
    --preview-label='alt-p: toggle desc, alt-j/k: scroll, tab: multi-select'
    --preview-label-pos='bottom'
    --preview-window 'down:55%:wrap'
    --bind 'alt-p:toggle-preview'
    --bind 'alt-d:preview-half-page-down,alt-u:preview-half-page-up'
    --bind 'alt-k:preview-up,alt-j:preview-down'
    --color 'pointer:green,marker:green'
  )

  format_packages() {
    awk '{
      colors["core"] = "\033[34m"; colors["extra"] = "\033[32m"; colors["community"] = "\033[36m"
      color = ($1 in colors) ? colors[$1] : "\033[0m"
      installed = ($4 == "[installed]") ? " [installed]" : ""
      printf "%s[%s]\033[0m %s%s\n", color, $1, $2, installed
    }'
  }

  pkg_names=$(pacman -Sl | format_packages | fzf "${fzf_args[@]}" --ansi | awk '{print $2}')

  if [[ -n "$pkg_names" ]]; then
    for p in $pkg_names; do
      pkg_install "$p" || true
    done
    sudo updatedb
    show_done
  fi
else
  fzf_args=(
    --multi
    --preview 'paru -Si {2}'
    --preview-label='alt-p: toggle desc, alt-b/B: toggle PKGBUILD, alt-j/k: scroll, tab: multi-select'
    --preview-label-pos='bottom'
    --preview-window 'down:55%:wrap'
    --bind 'alt-p:toggle-preview'
    --bind 'alt-d:preview-half-page-down,alt-u:preview-half-page-up'
    --bind 'alt-k:preview-up,alt-j:preview-down'
    --bind 'alt-b:change-preview:paru -Gpa {2} | tail -n +5'
    --bind 'alt-B:change-preview:paru -Siia {2}'
    --color 'pointer:green,marker:green'
  )

  format_packages() {
    awk '{
      colors["core"] = "\033[34m"; colors["extra"] = "\033[32m"; colors["aur"] = "\033[33m"
      color = ($1 in colors) ? colors[$1] : "\033[0m"
      installed = ($4 == "[installed]") ? " [installed]" : ""
      printf "%s[%s]\033[0m %s%s\n", color, $1, $2, installed
    }'
  }

  pkg_names=$(paru -Sl | format_packages | fzf "${fzf_args[@]}" --ansi | awk '{print $2}')

  if [[ -n "$pkg_names" ]]; then
    if command -v pkg_install >/dev/null 2>&1; then
      for p in $pkg_names; do
        pkg_install "$p" || true
      done
    else
      echo "$pkg_names" | tr '\n' ' ' | xargs paru -S --noconfirm
    fi
    sudo updatedb
    show_done
  fi
fi
