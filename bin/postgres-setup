#!/bin/bash
source "$HOME/.local/share/dotfiles/bin/lib/helpers.sh"
set -e

# Parse common flags (export DRY_RUN/FORCE_CACHYOS)
if type parse_common_flags >/dev/null 2>&1; then
  parse_common_flags "$@" >/dev/null
fi

log_header "PostgreSQL Setup"

# Check if running as root
if [ "$EUID" -eq 0 ]; then
  log_error "Don't run this script as root/sudo"
  exit 1
fi

# Install PostgreSQL
log_step "Installing PostgreSQL..."
sudo pacman -S --needed postgresql

# Initialize the database cluster
log_step "Initializing database cluster..."
if [ ! -d "/var/lib/postgres/data/PG_VERSION" ]; then
  sudo -u postgres initdb -D /var/lib/postgres/data \
    --locale=C.UTF-8 \
    --auth-local=peer \
    --auth-host=scram-sha-256
  log_success "Database cluster initialized"
else
  log_info "Database cluster already exists, skipping initialization"
fi

# Enable and start PostgreSQL service
log_step "Enabling and starting PostgreSQL service..."
sudo systemctl enable postgresql
sudo systemctl start postgresql

# Test connection
log_step "Testing connection..."
if sudo -u postgres psql -c '\l' &>/dev/null; then
  log_success "PostgreSQL is running and accessible"
else
  log_error "Could not connect to PostgreSQL"
fi

# Create user role
log_step "Creating PostgreSQL role for $USER..."
if sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='$USER'" | grep -q 1; then
  log_info "Role '$USER' already exists"
else
  sudo -u postgres createuser -s "$USER"
  log_success "Role '$USER' created with superuser privileges"
fi

# Install Beekeeper Studio
log_step "Installing Beekeeper Studio..."
if command -v pkg_install >/dev/null 2>&1; then
  if pkg_install beekeeper-studio-bin; then
    log_success "Beekeeper Studio installed"
  else
    log_info "Could not install Beekeeper Studio via pkg_install (may be unavailable)"
    log_detail "Install manually if desired: pkg_install beekeeper-studio-bin or paru -S beekeeper-studio-bin"
  fi
else
  if is_cachyos; then
    log_info "Skipping Beekeeper Studio on CachyOS (AUR package)"
    log_detail "Install manually if desired: pkg_install beekeeper-studio-bin or paru -S beekeeper-studio-bin"
  elif command -v paru &>/dev/null; then
    if paru -S --noconfirm beekeeper-studio-bin 2>/dev/null; then
      log_success "Beekeeper Studio installed"
    else
      log_error "Could not install Beekeeper Studio"
      log_detail "Install manually: pkg_install beekeeper-studio-bin or paru -S beekeeper-studio-bin"
    fi
  else
    log_info "paru not installed, skipping Beekeeper Studio"
    log_detail "Install manually: pkg_install beekeeper-studio-bin or paru -S beekeeper-studio-bin"
  fi
fi

show_done
