#!/bin/bash
source "$HOME/.local/share/dotfiles/bin/lib/helpers.sh"

# Parse common flags (export DRY_RUN/FORCE_CACHYOS)
if type parse_common_flags >/dev/null 2>&1; then
  parse_common_flags "$@" >/dev/null
fi

clear
log_header "Updates"

if ask_yes_no "Update now?"; then
  log_step "Update started..."
elif [ $? -eq 130 ]; then
  exit 130
else
  log_info "Update canceled."
  exit
fi

# Cache sudo credentials for entire update process
sudo -v

log_step "Checking for git updates..."
if command -v update-git &>/dev/null; then
  update-git
else
  log_info "update-git command not found, skipping"
fi
echo

if command -v pacman &>/dev/null; then
  if is_cachyos; then
    log_info "Running system update using pacman (CachyOS detected)"
    run_cmd "sudo pacman -Syu --noconfirm"
  else
    if command -v paru >/dev/null 2>&1; then
      run_cmd "paru -Syu --noconfirm"
    else
      run_cmd "sudo pacman -Syu --noconfirm"
    fi
  fi
else
  log_error "Platform not supported"
  exit 1
fi
echo

if command -v flatpak &>/dev/null; then
  log_step "Searching for Flatpak updates..."
  flatpak update
  echo
fi

orphans=$(pacman -Qtdq)
if [[ -n $orphans ]]; then
  log_step "Removing orphan system packages"
  for pkg in $orphans; do
    sudo pacman -Rs --noconfirm "$pkg" || true
  done
  log_success "Orphan packages removed"
else
  log_info "No orphan packages found"
fi
echo

# Reload
restart-app elephant
pkill -RTMIN+1 waybar
echo

if kernel_needs_reboot; then
  log_info "Linux kernel appears to differ from the running kernel package."
  if ask_yes_no "Reboot now to apply the new kernel?"; then
    sudo reboot now
  fi
fi

# Finishing
show_done
exit 1
