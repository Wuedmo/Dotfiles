#!/bin/bash

set -e

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
source "$SCRIPT_DIR/lib/helpers.sh"
source "$SCRIPT_DIR/lib/backup.sh"
DOTFILES_DIR="$HOME/.local/share/dotfiles"

# Configure gnome-keyring PAM (interactive and reversible)
log_info "Configuring gnome-keyring PAM integration..."

# /etc/pam.d/login
if [ -f "/etc/pam.d/login" ]; then
  backup_file "/etc/pam.d/login"
  if ! grep -q "pam_gnome_keyring.so" /etc/pam.d/login; then
    TMP_LOGIN=$(mktemp)
    cp /etc/pam.d/login "$TMP_LOGIN"
    sed -i '/auth.*include.*system-local-login/a auth       optional     pam_gnome_keyring.so' "$TMP_LOGIN" || true
    sed -i '/session.*include.*system-local-login/a session    optional     pam_gnome_keyring.so auto_start' "$TMP_LOGIN" || true

    echo
    echo "Proposed changes to /etc/pam.d/login:"
    diff -u /etc/pam.d/login "$TMP_LOGIN" || true

    if is_cachyos; then
      log_detail "CachyOS detected — review PAM changes carefully before applying."
    fi

    if ask_yes_no "Apply changes to /etc/pam.d/login?"; then
      run_cmd "sudo cp '$TMP_LOGIN' /etc/pam.d/login"
      log_success "/etc/pam.d/login updated"
    else
      log_detail "Skipped updating /etc/pam.d/login"
    fi

    rm -f "$TMP_LOGIN"
  else
    log_detail "/etc/pam.d/login already contains pam_gnome_keyring.so; skipping"
  fi
else
  log_detail "/etc/pam.d/login not found; skipping"
fi

# /etc/pam.d/passwd
if [ -f "/etc/pam.d/passwd" ]; then
  backup_file "/etc/pam.d/passwd"
  if ! grep -q "pam_gnome_keyring.so" /etc/pam.d/passwd; then
    TMP_PASSWD=$(mktemp)
    cp /etc/pam.d/passwd "$TMP_PASSWD"
    echo "password	optional	pam_gnome_keyring.so" >> "$TMP_PASSWD"

    echo
    echo "Proposed changes to /etc/pam.d/passwd:"
    diff -u /etc/pam.d/passwd "$TMP_PASSWD" || true

    if is_cachyos; then
      log_detail "CachyOS detected — review PAM changes carefully before applying."
    fi

    if ask_yes_no "Apply changes to /etc/pam.d/passwd?"; then
      run_cmd "sudo cp '$TMP_PASSWD' /etc/pam.d/passwd"
      log_success "/etc/pam.d/passwd updated"
    else
      log_detail "Skipped updating /etc/pam.d/passwd"
    fi

    rm -f "$TMP_PASSWD"
  else
    log_detail "/etc/pam.d/passwd already contains pam_gnome_keyring.so; skipping"
  fi
else
  log_detail "/etc/pam.d/passwd not found; skipping"
fi

log_success "gnome-keyring PAM configured (or skipped)"

# Configure pacman.conf
log_info "Configuring pacman.conf..."
PACMAN_CONF="/etc/pacman.conf"
DOT_PACMAN="$DOTFILES_DIR/default/pacman/pacman.conf"

[ -f "$PACMAN_CONF" ] && backup_file "$PACMAN_CONF"

if [ -f "$PACMAN_CONF" ]; then
  if cmp -s "$PACMAN_CONF" "$DOT_PACMAN"; then
    log_detail "Existing /etc/pacman.conf matches dotfiles version; skipping."
  else
    echo
    echo "Diff between current /etc/pacman.conf and dotfiles version:"
    sudo diff -u "$PACMAN_CONF" "$DOT_PACMAN" || true
    echo
    if is_cachyos; then
      log_detail "CachyOS detected — preserving distro pacman.conf is recommended."
      if ask_yes_no "Replace /etc/pacman.conf with the dotfiles version?"; then
        run_cmd "sudo cp '$DOT_PACMAN' '$PACMAN_CONF'"
        log_success "pacman.conf configured"
      else
        log_detail "Skipped replacing /etc/pacman.conf"
      fi
    else
      if ask_yes_no "Replace /etc/pacman.conf with the dotfiles version?"; then
        run_cmd "sudo cp '$DOT_PACMAN' '$PACMAN_CONF'"
        log_success "pacman.conf configured"
      else
        log_detail "Skipped replacing /etc/pacman.conf"
      fi
    fi
  fi
else
  run_cmd "sudo cp '$DOT_PACMAN' '$PACMAN_CONF'"
  log_success "pacman.conf configured"
fi

# Configure UFW
if is_installed "ufw"; then
  log_info "Configuring UFW..."
  sudo ufw default deny incoming
  sudo ufw default allow outgoing
  sudo ufw allow 53317/udp comment 'LocalSend'
  sudo ufw allow 53317/tcp comment 'LocalSend'
  sudo ufw allow 22/tcp comment 'SSH'
  sudo ufw --force enable
  sudo systemctl enable ufw
  log_success "UFW configured and enabled"
else
  log_detail "UFW not installed, skipping firewall configuration"
fi

# Detect and configure NVIDIA if present
if has_nvidia_gpu; then
  log_info "NVIDIA GPU detected, configuring for Hyprland..."
  bash "$SCRIPT_DIR/setup-nvidia"
fi

# Configure git user
log_info "Configuring git user information..."

CURRENT_GIT_NAME=$(git config --global user.name 2>/dev/null || true)
CURRENT_GIT_EMAIL=$(git config --global user.email 2>/dev/null || true)

if [ -n "$CURRENT_GIT_NAME" ] && [ -n "$CURRENT_GIT_EMAIL" ]; then
  log_detail "Git already configured:"
  log_detail "  Name:  $CURRENT_GIT_NAME"
  log_detail "  Email: $CURRENT_GIT_EMAIL"

  if ask_yes_no "Update git config?"; then
    CURRENT_GIT_NAME=""
    CURRENT_GIT_EMAIL=""
  fi
fi

if [ -z "$CURRENT_GIT_NAME" ]; then
  if _has_gum; then
    GIT_NAME=$(gum input --placeholder "Enter your name (used for git)" || true)
  else
    read -p "Enter your name: " GIT_NAME
  fi

  if [ -n "$GIT_NAME" ]; then
    git config --global user.name "$GIT_NAME"
    log_success "Set git user.name: $GIT_NAME"
  fi
fi

if [ -z "$CURRENT_GIT_EMAIL" ]; then
  if _has_gum; then
    GIT_EMAIL=$(gum input --placeholder "Enter your email (used for git)" || true)
  else
    read -p "Enter your email: " GIT_EMAIL
  fi

  if [ -n "$GIT_EMAIL" ]; then
    git config --global user.email "$GIT_EMAIL"
    log_success "Set git user.email: $GIT_EMAIL"
  fi
fi

# ly display manager configuration
if is_installed "ly"; then
  log_info "Configuring ly display manager..."
  sudo mkdir -p /etc/systemd/system/ly.service.d
  [ -f "/etc/systemd/system/ly.service.d/override.conf" ] && backup_file "/etc/systemd/system/ly.service.d/override.conf"
  sudo cp "$DOTFILES_DIR/default/ly/override.conf" /etc/systemd/system/ly.service.d/override.conf
  sudo systemctl daemon-reload

  [ -f "/etc/ly/config.ini" ] && backup_file "/etc/ly/config.ini"
  sudo rm -f /etc/ly/config.ini
  sudo cp "$DOTFILES_DIR/default/ly/config.ini" /etc/ly/config.ini

  log_success "ly display manager configured"
else
  log_detail "ly not installed, skipping"
fi

# Remove wait on network from system startup
log_info "Disabling systemd-networkd-wait-online.service..."
sudo systemctl disable systemd-networkd-wait-online.service 2>/dev/null || true

# Enable ssh agent
log_info "Enabling gcr-ssh-agent"
systemctl --user enable --now gcr-ssh-agent.socket

# Setup systemd user services
log_info "Setting up systemd user services..."
mkdir -p "$HOME/.config/systemd/user"

if [ -d "$DOTFILES_DIR/default/systemd/user" ]; then
  cp -f "$DOTFILES_DIR/default/systemd/user/"*.service "$HOME/.config/systemd/user/" 2>/dev/null || true
  log_detail "Service files copied"
fi

systemctl --user daemon-reload 2>/dev/null || log_detail "Failed to reload systemd"

USER_SERVICES=(
  "elephant.service"
  "hypridle.service"
  "mako.service"
  "sunsetr.service"
  "swayosd.service"
  "walker.service"
  "waybar.service"
  "hyprpaper.service"
)

for service in "${USER_SERVICES[@]}"; do
  if systemctl --user enable "$service" &>/dev/null; then
    log_detail "$service enabled"
  else
    log_detail "Failed to enable $service (may be missing)"
  fi
done

log_detail "Services will start on next login or Hyprland restart"

log_success "System configuration complete!"
