#!/bin/bash
set -e

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
source "$SCRIPT_DIR/lib/helpers.sh"
source "$SCRIPT_DIR/lib/backup.sh"

# Install additional NVIDIA packages
log_info "Installing additional NVIDIA packages..."
NVIDIA_PACKAGES=(
    "nvidia-utils"
    "egl-wayland"
    "libva-nvidia-driver"
    "qt5-wayland"
    "qt6-wayland"
)

for pkg in "${NVIDIA_PACKAGES[@]}"; do
    if spinner "Installing $pkg..." pkg_install "$pkg"; then
        log_success "$pkg"
    else
        log_detail "Failed to install $pkg (will continue)"
    fi
done

# Configure initramfs for NVIDIA early loading (safe, interactive)
log_info "Configuring initramfs for NVIDIA early loading..."
MKINITCPIO_CONF="/etc/mkinitcpio.conf"
NVIDIA_MODULES="nvidia nvidia_modeset nvidia_uvm nvidia_drm"

if command -v mkinitcpio >/dev/null 2>&1; then
    log_detail "mkinitcpio detected"
    if [ -f "$MKINITCPIO_CONF" ]; then
        backup_file "$MKINITCPIO_CONF"
        TMP_CONF=$(mktemp)
        sudo cat "$MKINITCPIO_CONF" > "$TMP_CONF"

        # Update MODULES line: preserve order, remove duplicates, append NVIDIA modules
        awk -v add="$NVIDIA_MODULES" '
        /^MODULES=\(/ {
          line=$0
          sub(/^MODULES=\(/, "", line); sub(/\).*$/, "", line)
          n=split(line, arr, /[[:space:]]+/)
          cnt=0
          for(i=1;i<=n;i++) if(arr[i]!="") { seen[arr[i]]=1; list[++cnt]=arr[i] }
          cnt2=split(add, newarr, " ")
          for(i=1;i<=cnt2;i++) if(newarr[i]!="" && !seen[newarr[i]]) { list[++cnt]=newarr[i]; seen[newarr[i]]=1 }
          printf "MODULES=("
          for(i=1;i<=cnt;i++) { if(i>1) printf " "; printf "%s", list[i] }
          print ")"
          next
        }
        { print }
        ' "$TMP_CONF" > "$TMP_CONF.new" && mv "$TMP_CONF.new" "$TMP_CONF"

        # Clean up potential double spaces
        sed -i -E 's/  +/ /g' "$TMP_CONF" || true

        echo
        echo "Diff of proposed /etc/mkinitcpio.conf changes:"
        sudo diff -u "$MKINITCPIO_CONF" "$TMP_CONF" || true

        if ask_yes_no "Apply these mkinitcpio changes?"; then
            run_cmd sudo cp "$TMP_CONF" "$MKINITCPIO_CONF"
            log_success "mkinitcpio.conf updated"

            if ask_yes_no "Regenerate initramfs now (mkinitcpio -P)?"; then
                log_info "Regenerating initramfs..."
                spinner "Regenerating initramfs..." run_cmd sudo mkinitcpio -P
                log_success "Initramfs regenerated"
            else
                log_detail "Skipping initramfs regeneration (you should run: sudo mkinitcpio -P)"
            fi
        else
            log_detail "Skipped applying mkinitcpio changes"
        fi

        rm -f "$TMP_CONF"
    else
        log_detail "$MKINITCPIO_CONF not found; skipping"
    fi
elif command -v dracut >/dev/null 2>&1; then
    log_detail "dracut detected; preparing a safe suggestion for dracut configuration"
    # Prepare a suggested dracut conf snippet (commented) so user can review before applying
    SUGGEST_CONF_DIR="/etc/dracut.conf.d"
    SUGGEST_CONF_FILE="$SUGGEST_CONF_DIR/99-dotfiles-nvidia.conf"
    TMP_DRACUT=$(mktemp)
    cat > "$TMP_DRACUT" <<EOF
# NVIDIA dracut hint generated by dotfiles
# Review before applying. Common options to include NVIDIA modules in initramfs:
# Example:
# add_dracutmodules+="nvidia"
# Or explicitly install module files (replace with matching kernel paths if needed):
# dracut_install_items+="/usr/lib/modules/\
#	\$(uname -r)/kernel/drivers/video/nvidia.ko"
# After applying, regenerate initramfs with: sudo dracut --force

## End of suggestion
EOF

    if [ -f "$SUGGEST_CONF_FILE" ]; then
        echo
        echo "Diff of proposed $SUGGEST_CONF_FILE changes:"
        sudo diff -u "$SUGGEST_CONF_FILE" "$TMP_DRACUT" || true
    else
        echo
        echo "Proposed dracut suggestion (not yet written):"
        cat "$TMP_DRACUT"
    fi

    if ask_yes_no "Write suggested dracut hint to $SUGGEST_CONF_FILE and optionally regenerate initramfs?"; then
        run_cmd sudo mkdir -p "$SUGGEST_CONF_DIR"
        run_cmd sudo cp "$TMP_DRACUT" "$SUGGEST_CONF_FILE"
        log_success "Dracut suggestion written to $SUGGEST_CONF_FILE"
        if ask_yes_no "Regenerate initramfs now with dracut --force?"; then
            spinner "Regenerating initramfs (dracut)..." run_cmd sudo dracut --force
            log_success "dracut regeneration attempted"
        else
            log_detail "Skipping dracut regeneration (you can run: sudo dracut --force)"
        fi
    else
        log_detail "Skipped writing dracut suggestion file"
    fi
    rm -f "$TMP_DRACUT"
else
    log_detail "No known initramfs tool detected (mkinitcpio/dracut); skipping automatic initramfs changes"
fi

log_success "NVIDIA configuration complete!"
